<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared Clipboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Include highlight.js for language detection and syntax highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/styles/atom-one-dark.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/lib/highlight.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/lib/languages/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/lib/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/lib/languages/html.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/lib/languages/css.min.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

  <div class="max-w-4xl mx-auto px-4 py-8">

    <h1 class="text-4xl font-semibold text-center text-indigo-600 mb-6">Shared Clipboard</h1>

    <!-- New Clip Section -->
    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Paste New Clip</h2>

      <!-- Language Selector -->
      <div class="mb-4">
        <label for="language" class="block text-sm font-medium text-gray-600">Select Language</label>
        <select id="language" class="w-full p-3 mt-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="plaintext">Plain Text</option>
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
        </select>
      </div>

      <textarea id="newClipText" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4" placeholder="Paste your text or code here..." rows="6" oninput="detectLanguage()"></textarea>
      <button onclick="submitClip()" class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Share Clip</button>
    </div>

    <!-- Flush Database Section -->
    <div class="bg-red-600 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold text-white mb-4">Flush All Clips</h2>
      <button onclick="flushDatabase()" class="w-full py-3 bg-red-800 text-white rounded-lg hover:bg-red-700 transition-colors">Flush All Clips</button>
    </div>

    <!-- Shared Clips Section -->
    <div id="clipsList">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Shared Clips</h2>
      <div class="space-y-4" id="clipContainer">
        <!-- Clips will be injected here -->
      </div>
    </div>

  </div>

  <script>
    // Check if highlight.js has loaded properly
    function isHljsLoaded() {
      return typeof hljs !== 'undefined';
    }

    // Language detection function using highlight.js
    function detectLanguage() {
      const text = document.getElementById('newClipText').value;
      const languageSelect = document.getElementById('language');
      const detectedLanguage = hljs.highlightAuto(text).language;

      // If auto-detection is different from the selected language, suggest the detected language
      if (languageSelect.value === 'plaintext' || languageSelect.value === 'javascript') {
        languageSelect.value = detectedLanguage;
      }
    }

    // Fetch and display all shared clips
    async function fetchClips() {
      try {
        const response = await fetch('/clips');
        if (!response.ok) {
          throw new Error('Failed to fetch clips');
        }
        const clips = await response.json();
        const clipContainer = document.getElementById('clipContainer');
        clipContainer.innerHTML = '';

        if (clips.length === 0) {
          clipContainer.innerHTML = '<p>No clips shared yet.</p>';
        }

        clips.forEach(clip => {
          const clipElement = document.createElement('div');
          clipElement.classList.add('bg-white', 'p-6', 'rounded-lg', 'shadow-lg', 'text-gray-800');

          // Display the language
          const languageLabel = document.createElement('div');
          languageLabel.classList.add('font-semibold', 'text-gray-600', 'mb-2');
          languageLabel.innerText = `Language: ${clip.language.charAt(0).toUpperCase() + clip.language.slice(1)}`;
          clipElement.appendChild(languageLabel);

          // Render code with syntax highlighting based on selected language
          if (clip.language !== 'plaintext') {
            clipElement.innerHTML += `<pre class="language-${clip.language}"><code>${escapeHtml(clip.text)}</code></pre>`;
          } else {
            clipElement.innerText = clip.text; // Plain text will not have syntax highlighting
          }

          clipContainer.appendChild(clipElement);
        });

        // Highlight the newly added code blocks using highlight.js
        if (isHljsLoaded()) {
          hljs.highlightAll();
        }
      } catch (error) {
        console.error('Error fetching clips:', error);
      }
    }

    // Submit a new clip
    async function submitClip() {
      const clipText = document.getElementById('newClipText').value;
      const language = document.getElementById('language').value;
      if (!clipText) return alert('Please paste some text first!');

      const clip = {
        id: new Date().toISOString(),
        text: clipText,
        language: language,
        name: "NA",
        device_type: "NA",
        browser: "NA"
      };

      try {
        const response = await fetch('/add_clip', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(clip)
        });

        if (!response.ok) {
          throw new Error('Failed to submit clip');
        }

        document.getElementById('newClipText').value = ''; // Clear textarea
        fetchClips(); // Refresh the clip list
      } catch (error) {
        console.error('Error submitting clip:', error);
      }
    }

    // Flush the database (delete all clips)
    async function flushDatabase() {
      try {
        const response = await fetch('/flush', {
          method: 'DELETE',
        });

        if (!response.ok) {
          throw new Error('Failed to flush the database');
        }

        // Clear the displayed clips
        document.getElementById('clipContainer').innerHTML = '<p>No clips shared yet.</p>';
        alert("Database flushed successfully!");
      } catch (error) {
        console.error('Error flushing database:', error);
        alert("Error flushing the database.");
      }
    }

    // Escape HTML to prevent XSS and handle special characters
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function (match) {
        const escapeMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return escapeMap[match];
      });
    }

    // Initial load of clips
    window.onload = function() {
      fetchClips(); // Fetch clips on initial load
    };
  </script>

</body>
</html>
